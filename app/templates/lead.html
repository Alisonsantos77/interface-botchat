{% extends "base.html" %} {% block content %}
<div class="flex flex-col md:flex-row h-screen bg-gray-50 dark:bg-gray-900">
	<!-- Sidebar - Mapa de Leads -->
	<div
		class="w-full md:w-1/3 lg:w-1/4 xl:w-1/5 bg-white dark:bg-gray-800 shadow-md overflow-y-auto border-r border-gray-200 dark:border-gray-700">
		<div class="p-4">
			<div class="flex items-center justify-between mb-4">
				<h2 class="text-xl font-bold text-gray-800 dark:text-white">Leads</h2>
				<span
					class="bg-blue-100 text-blue-800 text-xs font-medium inline-flex items-center px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">
					<svg class="w-3 h-3 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
						viewBox="0 0 20 20">
						<path
							d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm3.982 13.982a1 1 0 0 1-1.414 0l-3.274-3.274A1.012 1.012 0 0 1 9 10V6a1 1 0 0 1 2 0v3.586l2.982 2.982a1 1 0 0 1 0 1.414Z" />
					</svg>
					Total: {{ leads|length }}
				</span>
			</div>

			<!-- Search box -->
			<div class="relative mb-4">
				<div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
					<svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
						xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
						<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
					</svg>
				</div>
				<input type="text" id="search-leads"
					class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
					placeholder="Buscar leads...">
			</div>
		</div>

		<!-- Leads list -->
		<div class="space-y-2 px-2">
			{% for lead in leads %}
			<a href="{{ url_for('get_leads_ia', ia_id=lead.ia_id, lead_id=lead.id) }}" class="flex flex-col p-3 rounded-lg transition-all duration-200 ease-in-out
                {% if selected_lead and selected_lead.id == lead.id %}
                bg-blue-100 border-l-4 border-blue-600 dark:bg-blue-900/30 dark:border-blue-500
                {% else %}
                hover:bg-gray-100 dark:hover:bg-gray-700
                {% endif %}">
				<div class="flex items-center justify-between">
					<span class="font-medium text-gray-800 dark:text-white">{{ lead.name }}</span>
					<span
						class="inline-flex items-center justify-center w-6 h-6 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full dark:bg-blue-900 dark:text-blue-300">
						{% set msg_count = lead.message|length %}
						{{ msg_count }}
					</span>
				</div>
				<div class="flex items-center mt-1 text-sm text-gray-600 dark:text-gray-400">
					<svg class="w-4 h-4 mr-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor"
						viewBox="0 0 19 18">
						<path
							d="M18 13.446a3.02 3.02 0 0 0-.946-1.985l-1.4-1.4a3.054 3.054 0 0 0-4.218 0l-.7.7a.983.983 0 0 1-1.39 0l-2.1-2.1a.983.983 0 0 1 0-1.389l.7-.7a2.98 2.98 0 0 0 0-4.217l-1.4-1.4a2.824 2.824 0 0 0-4.218 0c-3.619 3.619-3 8.229 1.752 12.979C6.785 16.639 9.45 18 11.912 18a7.175 7.175 0 0 0 5.139-2.325A2.9 2.9 0 0 0 18 13.446Z" />
					</svg>
					{{ lead.phone }}
				</div>
				<div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
					Última interação: {{ lead.updated_at }}
				</div>
			</a>
			{% endfor %}
		</div>
	</div>

	<!-- Chat do Lead Selecionado -->
	<div class="w-full md:w-2/3 lg:w-3/4 xl:w-4/5 bg-gray-50 dark:bg-gray-900 flex flex-col h-screen">
		{% if selected_lead %}
		<div class="p-4 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
			<div class="flex items-center justify-between">
				<div>
					<h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
						<span>{{ selected_lead.name }}</span>
						<span
							class="ml-2 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">{{
							selected_lead.ia_name }}</span>
					</h2>
					<p class="text-sm text-gray-600 dark:text-gray-400">{{ selected_lead.phone }}</p>
				</div>

				<button class="text-red-600 hover:text-red-800 dark:text-red-500 dark:hover:text-red-400"
					data-modal-target="deletePromptModal{{ selected_lead.id }}"
					data-modal-toggle="deletePromptModal{{ selected_lead.id }}" type="button">
					<svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
						viewBox="0 0 18 20">
						<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M1 5h16M7 8v8m4-8v8M7 1h4a1 1 0 0 1 1 1v3H6V2a1 1 0 0 1 1-1ZM3 5h12v13a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V5Z" />
					</svg>
				</button>
			</div>
		</div>

		<div class="flex-1 overflow-y-auto p-4 space-y-4">
			<!-- Resumo da Conversa -->
			{% if selected_lead.resume %}
			<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
				<div class="flex items-center gap-2 mb-2">
					<svg class="w-5 h-5 text-blue-600 dark:text-blue-500" aria-hidden="true"
						xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
						<path
							d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z" />
					</svg>
					<h3 class="text-lg font-medium text-gray-900 dark:text-white">Resumo da conversa</h3>
				</div>
				<div class="bg-gray-50 dark:bg-gray-700 rounded-md p-3 border border-gray-200 dark:border-gray-600">
					<p class="text-gray-700 dark:text-gray-300 whitespace-pre-line">{{ selected_lead.resume }}</p>
				</div>
			</div>
			{% endif %}

			<!-- Chat separator -->
			<div class="flex items-center gap-3">
				<hr class="flex-grow border-gray-300 dark:border-gray-700">
				<span class="text-sm font-medium text-gray-500 dark:text-gray-400">Conversa</span>
				<hr class="flex-grow border-gray-300 dark:border-gray-700">
			</div>

			<!-- Chat messages -->
			<div class="space-y-4">
				{% for msg in selected_lead.message %}
				{% if msg.role == 'user' %}
				<!-- User message -->
				<div class="flex justify-start">
					<div class="max-w-[75%] bg-gray-100 dark:bg-gray-700 p-3 rounded-lg shadow-sm">
						<p class="text-gray-800 dark:text-gray-200">{{ msg.content }}</p>
						{% if msg.name %}
						<div class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ msg.name }}</div>
						{% endif %}
					</div>
				</div>
				{% elif msg.role == 'assistant' %}
				<!-- Assistant message -->
				<div class="flex justify-end">
					<div class="max-w-[75%] bg-blue-600 p-3 rounded-lg shadow-sm">
						<p class="text-white">{{ msg.content }}</p>
					</div>
				</div>
				{% endif %}
				{% endfor %}
			</div>
		</div>

		<!-- Delete Modal -->
		<div id="deletePromptModal{{ selected_lead.id }}" tabindex="-1" aria-hidden="true"
			class="fixed top-0 left-0 right-0 z-50 hidden p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
			<div class="relative w-full max-w-md max-h-full">
				<div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
					<button type="button"
						class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
						data-modal-hide="deletePromptModal{{ selected_lead.id }}">
						<svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
							viewBox="0 0 14 14">
							<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
						</svg>
						<span class="sr-only">Fechar</span>
					</button>
					<form action="/delete-lead/{{ selected_lead.id }}" method="POST">
						<div class="p-6 text-center">
							<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true"
								xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
								<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
									stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
							</svg>
							<h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Tem certeza que deseja
								excluir o Lead <strong>{{ selected_lead.name }}</strong>?</h3>
							<button type="submit"
								class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
								Sim, excluir
							</button>
							<button data-modal-hide="deletePromptModal{{ selected_lead.id }}" type="button"
								class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Cancelar</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		{% else %}
		<!-- No lead selected state -->
		<div class="flex items-center justify-center h-full">
			<div class="text-center p-5">
				<svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true"
					xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 18">
					<path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
						d="M14 3a3 3 0 1 1-1.614 5.53M15 12a4 4 0 0 1 4 4v1h-3.348M10 4.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0ZM5 11h3a4 4 0 0 1 4 4v2H1v-2a4 4 0 0 1 4-4Z" />
				</svg>
				<h2 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Nenhum lead selecionado</h2>
				<p class="text-gray-600 dark:text-gray-400">Selecione um lead no painel lateral para visualizar o chat.
				</p>
			</div>
		</div>
		{% endif %}
	</div>
</div>

<script>
	// Search functionality for leads
	document.getElementById('search-leads').addEventListener('keyup', function () {
		const searchValue = this.value.toLowerCase();
		const leadItems = document.querySelectorAll('.w-full.md\\:w-1\\/3 a');

		leadItems.forEach(item => {
			const leadName = item.querySelector('.font-medium').textContent.toLowerCase();
			const leadPhone = item.querySelectorAll('.text-gray-600')[0].textContent.toLowerCase();

			if (leadName.includes(searchValue) || leadPhone.includes(searchValue)) {
				item.style.display = '';
			} else {
				item.style.display = 'none';
			}
		});
	});
</script>
{% endblock %}