{% extends "base.html" %}
{% block title %}Leads{% endblock %}
{% block content %}
<div class="grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-4 h-screen p-4">
	<!-- Coluna de Conversas (Esquerda) -->
	<div class="bg-white rounded-lg shadow-sm overflow-y-auto">
		<div class="p-4 border-b">
			<h4 class="font-bold mb-2">Leads</h4>
			<form method="GET" action="{{ url_for('get_leads_ia', ia_id=leads[0].ia_id if leads else 0) }}"
				class="flex items-center gap-2">
				<input type="text" name="search_query" value="{{ search_query or '' }}"
					placeholder="Buscar por nome ou telefone..."
					class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
				<button type="submit" class="p-2 text-gray-500 hover:text-gray-700">
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
							d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
					</svg>
				</button>
			</form>
		</div>
		<ul class="divide-y">
			{% for lead in leads %}
			<li
				class="{% if selected_lead and lead.id == selected_lead.id %}bg-gray-100{% endif %} flex items-center p-4 hover:bg-gray-50">
				<a href="{{ url_for('get_leads_ia', ia_id=lead.ia_id, lead_id=lead.id) }}"
					class="flex items-center gap-3 w-full">
					<img src="https://api.dicebear.com/6.x/notionists/svg?seed={{ lead.name or lead.phone }}"
						alt="Avatar" class="w-10 h-10 rounded-full">
					<div class="flex-1">
						<div class="flex justify-between items-center">
							<span
								class="{% if selected_lead and lead.id == selected_lead.id %}font-bold text-gray-900{% else %}text-gray-700{% endif %}">
								{{ lead.name or lead.phone }}
							</span>
							<div class="flex items-center gap-2">
								{% if lead.message|length > 0 %}
								<span class="text-xs bg-blue-500 text-white rounded-full px-2 py-1">{{
									lead.message|length }}</span>
								{% endif %}
								<span class="text-xs text-gray-500">{{ lead.updated_at.strftime('%H:%M') }}</span>
							</div>
						</div>
						<p class="text-xs text-gray-500 truncate">
							{% if lead.message and lead.message|length > 0 %}
							{{ lead.message[-1].content[:20] ~ '...' if lead.message[-1].content|length > 20 else
							lead.message[-1].content }}
							{% else %}
							Sem mensagens
							{% endif %}
						</p>
					</div>
					<form action="{{ url_for('delete_lead', id_lead=lead.id) }}" method="post"
						onsubmit="return confirm('Excluir este lead?');" class="ml-2">
						<button type="submit" class="text-red-600 hover:text-red-800">
							<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M6 18L18 6M6 6l12 12" />
							</svg>
						</button>
					</form>
				</a>
			</li>
			{% endfor %}
		</ul>
	</div>

	<!-- Área de Chat e Resumo (Direita) -->
	<div class="bg-white rounded-lg shadow-sm flex flex-col">
		{% if selected_lead %}
		<div class="p-4 border-b flex items-center gap-3">
			<img src="https://api.dicebear.com/6.x/notionists/svg?seed={{ selected_lead.name or selected_lead.phone }}"
				alt="Avatar" class="w-10 h-10 rounded-full">
			<div>
				<h4 class="font-bold">{{ selected_lead.name or selected_lead.phone }}</h4>
				<span class="text-xs text-gray-500">Última atualização: {{ selected_lead.updated_at.strftime('%H:%M')
					}}</span>
			</div>
		</div>
		<div class="flex-1 p-4 overflow-y-auto max-h-72 space-y-4">
			{% for msg in selected_lead.message %}
			<div
				class="flex {% if msg.role == 'user' %}justify-end{% else %}justify-start{% endif %} items-start gap-2">
				{% if msg.role != 'user' %}
				<img src="https://api.dicebear.com/6.x/notionists/svg?seed={{ selected_lead.ia_name }}" alt="IA Avatar"
					class="w-8 h-8 rounded-full">
				{% endif %}
				<div class="max-w-xs">
					<div
						class="{% if msg.role == 'user' %}bg-blue-500 text-white{% else %}bg-gray-100{% endif %} rounded-lg p-3">
						<span>{{ msg.content }}</span>
					</div>
					<span class="text-xs text-gray-500 mt-1">{{ selected_lead.updated_at.strftime('%H:%M') }}</span>
				</div>
				{% if msg.role == 'user' %}
				<img src="https://api.dicebear.com/6.x/notionists/svg?seed={{ selected_lead.name or selected_lead.phone }}"
					alt="User Avatar" class="w-8 h-8 rounded-full">
				{% endif %}
			</div>
			{% endfor %}
		</div>
		{% if selected_lead.resume %}
		<div class="p-4 border-t bg-blue-50 text-blue-800">
			<strong>Resumo:</strong> {{ selected_lead.resume }}
		</div>
		{% endif %}
		{% else %}
		<div class="flex-1 flex items-center justify-center bg-gray-100 rounded-lg">
			<span class="text-gray-700">Selecione um lead para visualizar a conversa.</span>
		</div>
		{% endif %}
	</div>
</div>
{% endblock %}